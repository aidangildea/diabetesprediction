---
title: "EDA"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

```{r library}
library(corrplot)
library(ggplot2)
library(magrittr)
library(tibble)
library(ggcorrplot)
library(tidyverse)
library(ISLR)
library(ggmosaic)
require(nnet)
library(car)
```


Load in the data.

```{r}
#db_binary <- read.csv("~/Desktop/STA 325/diabetesprediction/data/diabetes_binary.csv")
#db_5050 <- read.csv("~/Desktop/STA 325/diabetesprediction/data/diabetes_binary_5050split.csv")
#db_012 <- read.csv("~/Desktop/STA 325/diabetesprediction/data/diabetes_012.csv")

db_binary <- read_csv("diabetes_binary.csv")
db_5050 <- read_csv("diabetes_binary_5050split.csv")
db_012 <- read_csv("diabetes_012.csv")

#db_binary <- read_csv("https://raw.githubusercontent.com/aidangildea/diabetesprediction/main/diabetes_binary.csv")
#db_5050 <- read_csv("https://raw.githubusercontent.com/aidangildea/diabetesprediction/main/diabetes_012.csv")
#db_012 <- read_csv("https://raw.githubusercontent.com/aidangildea/diabetesprediction/main/diabetes_012.csv")

# Making all categorical variables into factors
cols <- names(db_binary) %in% c("BMI", "MentHlth", "PhysHlth")
db_binary[!cols] <- data.frame(lapply(db_binary[!cols], factor))

# Coercing `PhysHlth` and "MentHlth` to integer type
db_binary["PhysHlth"] <- data.frame(lapply(db_binary["PhysHlth"], as.integer))
db_binary["MentHlth"] <- data.frame(lapply(db_binary["MentHlth"], as.integer))
tibble(db_binary)
```

We can begin by creating correlation matrix plots to assess if there are any predictors with significant correlation towards our response variable `Diabetes_012`. There are 21 predictors, and therefore, creating one correlation matrix plot would be busy and difficult to understand. Since we are using a correlation matrix plot to investigate the predictors' correlation with the response - and not one another - splitting the variables into three visualizations is appropriate.

```{r mosaic plots}
bp_mosaic <- ggplot(data = db_binary) +
  geom_mosaic(aes(x=product(Diabetes_binary, HighBP), fill = Diabetes_binary)) +
  scale_fill_manual(values = c("#7EAED2FF", "#EDB687FF")) +
  labs(title = "High BP vs. Diabetes Diagnosus")
  
bp_mosaic
  
```

From the correlation matrix plots, it seems that there are 12 significant main effects on our response variable `Diabetes_012`. There are nine variables (`HighBP`, `HighChol`, `BMI`, `Stroke`, `HeartDiseaseorAttack`,  `GenHlth`, `PhysHlth`, `DiffWalk`, `Age`) that demonstrate a significant positive correlation with our response, while there are three variables (`PhysActivity`, `Education`, `Income`) with a significant negative correlation.

We should validate these assumptions from the correlation matrix plots by developing additional exploratory visualizations between our predictors of interest and the response. 

```{r viz}
bmi_plot <- ggplot(db_012, aes(factor(Diabetes_012), BMI)) +
  geom_boxplot() +
  labs(title = 'Diabetes And BMI', x = "Diabetes_012", y = "BMI")
bmi_plot

median_df <- db_012 %>%
  group_by(Diabetes_012) %>%
  summarize(median=median(BMI))

ggplot(data = db_012, mapping = aes(x = BMI, colour = factor(Diabetes_012))) +
  geom_freqpoly(binwidth = 1) +
  geom_vline(data = median_df, aes(xintercept = median, 
                                       color = factor(Diabetes_012)), linetype = "dotted")

bp_plot <- ggplot(db_012, aes(x = factor(Diabetes_012), fill = factor(HighBP))) +
  geom_bar(position = "fill") +
  labs(title = 'Diabetes And HighBP', x = "Diabetes_012", y = "Count", 
       fill = "HighBP") +
    scale_fill_manual(values = c("#7EAED2FF", "#EDB687FF"))
bp_plot

chol_plot <- ggplot(db_012, aes(x = factor(Diabetes_012), fill = factor(HighChol))) +
  geom_bar(position = "fill") +
  labs(title = 'Diabetes And HighChol', x = "Diabetes_012", y = "Count", 
       fill = "HighChol") +
  scale_fill_manual(values = c("#7EAED2FF", "#EDB687FF"))
chol_plot

stroke_plot <- ggplot(db_012, aes(x = factor(Diabetes_012), fill = factor(Stroke))) +
  geom_bar(position = "fill") +
  labs(title = 'Diabetes And Stroke', x = "Diabetes_012", y = "Count", 
       fill = "Stroke") +
  scale_fill_manual(values = c("#7EAED2FF", "#EDB687FF"))
stroke_plot

heart_plot <- ggplot(db_012, aes(x = factor(Diabetes_012), fill = factor(HeartDiseaseorAttack))) +
  geom_bar(position = "fill") +
  labs(title = 'Diabetes And Heart Disease or Attack', x = "Diabetes_012", y = "Count", 
       fill = "Heart Disease or Attack") +
  scale_fill_manual(values = c("#7EAED2FF", "#EDB687FF"))
heart_plot

genhealth_plot <- ggplot(db_012, aes(factor(Diabetes_012), GenHlth)) +
  geom_boxplot() +
  labs(title = 'Diabetes And General Health', x = "Diabetes_012", y = "General Health")
genhealth_plot

physhealth_plot <- ggplot(db_012, aes(factor(Diabetes_012), PhysHlth)) +
  geom_boxplot() +
  labs(title = 'Diabetes And Physical Health', x = "Diabetes_012", y = "Physical Health")
physhealth_plot

diffwalk_plot <- ggplot(db_012, aes(x = factor(Diabetes_012), fill = factor(DiffWalk))) +
  geom_bar(position = "fill") +
  labs(title = 'Diabetes And Difficulty Walking', x = "Diabetes_012", y = "Count", 
       fill = "Difficulty Walking") +
  scale_fill_manual(values = c("#7EAED2FF", "#EDB687FF"))
diffwalk_plot

age_plot <- ggplot(db_012, aes(factor(Diabetes_012), Age)) +
  geom_boxplot() +
  labs(title = 'Diabetes And Age', x = "Diabetes_012", y = "Age")
age_plot
```

Next, we will evaluate whether our continuous variable, BMI, is skewed:

```{r hist}
ggplot(db_012, aes(x = BMI)) + 
  geom_histogram(fill = "blue", binwidth = 2)
```

```{r dset-glimpse}
glimpse(db_binary)
```

```{r starter-log-model}
log_model_1 <- glm(Diabetes_binary ~ ., data = db_binary, family = "binomial")
summary(log_model_1)
```

```{r interactions-log-model}
log_model_2 <- glm(Diabetes_binary ~ HighBP + HighChol + CholCheck + BMI + Stroke + HeartDiseaseorAttack + PhysActivity + Fruits + HvyAlcoholConsump + GenHlth + MentHlth + DiffWalk + Sex + Age + Education + Income + Age * HighBP + Age * HeartDiseaseorAttack + Age * HighChol + Age * GenHlth + Sex * GenHlth, data = db_binary, family = "binomial")
summary(log_model_2)
```

```{r larger-interactions-log-model}
log_model_3 <- glm(Diabetes_binary ~ HighBP + HighChol + CholCheck + BMI + Stroke + HeartDiseaseorAttack + PhysActivity + Fruits + HvyAlcoholConsump + GenHlth + MentHlth + DiffWalk + Sex + Age + Education + Income + Age * HighBP + Age * HeartDiseaseorAttack + Age * HighChol + Age * GenHlth + Sex * GenHlth + Sex * HighBP + Sex * MentHlth, data = db_binary, family = "binomial")
summary(log_model_3)
```

```{r multi-collinearity}
vif(log_model_1)
vif(log_model_2)
vif(log_model_3)
```

```{r anova}
anova(log_model_2, log_model_3, test ="Chisq")
anova(log_model_1)
anova(log_model_2)
anova(log_model_3)
```


```{r tree}
# Classification Tree with rpart
library(rpart) #for fitting decision trees
library(rpart.plot) #for plotting decision trees

# grow tree
fit <- rpart(Diabetes_binary ~ . - Diabetes_binary,
   method="class", data= db_binary)

printcp(fit) # display the results
plotcp(fit) # visualize cross-validation results
summary(fit) # detailed summary of splits

# plot tree
plot(fit, uniform=TRUE,
   main="Classification Tree for Diabetes")
text(fit, use.n=TRUE, all=TRUE, cex=.8)
```
```{r}
library(party)
TreeModel <- ctree(Diabetes_binary ~ . -Diabetes_binary, data = db_binary)
plot(TreeModel, type= "simple")
```

```{r}
library(randomForest)
set.seed(1)
rf <- randomForest(Diabetes_binary~.-Diabetes_binary, data = db_binary, 
                          mtry = 4, importance = TRUE)
plot(rf)
```




```{r}
library(tree)
tree3 <- tree(Diabetes_binary ~ . - Diabetes_binary, db_binary)
summary(tree3)
plot(tree3)
text(tree3, pretty = 0)

```
```{r}
library(gbm)
set.seed(1)
boost <- gbm(Diabetes_binary ~.-Diabetes_binary, data = db_binary, 
                    distribution = "gaussian", n.trees = 5000,
                    interaction.depth = 3)
summary(boost)
```



```{r}
age_mosaic <- ggplot(data = db_binary) +
  geom_mosaic(aes(x=product(Diabetes_binary, Age), fill = Diabetes_binary)) +
  scale_fill_manual(values = c("#7EAED2FF", "#EDB687FF")) +
  labs(title = "Age vs. Diabetes Diagnosis")
  
age_mosaic
```

